# Quickstart: Black Duck Security Scan Action with blackducksca:
#     https://documentation.blackduck.com/bundle/bridge/page/documentation/t_github-blackduck-quickstart.html
name: Black Duck Security Scan
on:
  push:
    branches:
      - main
      - master
      - develop
      - stage
      - release
  pull_request:
    branches:
      - main
      - master
      - develop
      - stage
      - release
  workflow_dispatch: {}
# GitHub token permissions for post-scan actions. Required for built-in GITHUB_TOKEN; if using a PAT with equivalent scopes, permissions block can be commented out.
permissions:
  contents: write               # Required to push changes or create fix branches
  pull-requests: write          # Required to add comments or create fix pull requests
jobs:
  blackducksca:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Black Duck Security Scan
        id: black-duck-security-scan
        uses: blackduck-inc/black-duck-security-scan@v2
        with:
          ### SCANNING: Required fields
          blackducksca_url: ${{ vars.BLACKDUCKSCA_URL }}
          blackducksca_token: ${{ secrets.BLACKDUCKSCA_TOKEN }}
          ### Mark build status if policy violating issues are found
          mark_build_status: failure  # Set to success, failure, or skip
          ### Configuration if Bridge diagnostic files needs to be uploaded
          include_diagnostics: true
          ### GITHUB TOKEN
          github_token: ${{ secrets.GITHUB_TOKEN }}  # Required when PR comments or sarif reports enabled
          blackducksca_prComment_enabled: true


          ### SCAN CONFIGURATION: Enabled for comprehensive scanning
          blackducksca_waitForScan: true # Wait for scan completion before proceeding

          ### FIX PULL REQUEST CREATION: Enabled for vulnerability remediation
          blackducksca_fixpr_enabled: true

          ### SARIF report parameters
          blackducksca_reports_sarif_create: true # Create SARIF report and upload it as artifact
          blackducksca_upload_sarif_report: true # Upload SARIF report in GitHub Advanced Security tab

  # C/C++ specific scanning with build capture for accurate dependency detection
  blackduck-cpp-scan:
    runs-on: ubuntu-latest
    needs: blackducksca
    strategy:
      matrix:
        component: [client, server, utility_library]
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Python for Black Duck C/C++ Scanner
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Black Duck C/C++ Scanner
        run: pip install blackduck-c-cpp==3.0.5

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Setup Build Environment
        run: |
          mkdir -p blackduck-cpp-output/${{ matrix.component }}
          chmod +x build_all.sh

      - name: Run C/C++ Scan with Build Capture - ${{ matrix.component }}
        run: |
          cd ${{ matrix.component }}
          mkdir -p build
          blackduck-c-cpp \
            -bd ${{ vars.BLACKDUCKSCA_URL }} \
            -a ${{ secrets.BLACKDUCKSCA_TOKEN }} \
            -bc "cmake -B build . && cmake --build build" \
            -d . \
            -od ../blackduck-cpp-output/${{ matrix.component }} \
            -proj "jenkins-demo-cpp-${{ matrix.component }}" \
            -vers "${{ github.sha }}" \
            -i false \
            -as "--snippet-matching --license-search --upload-source"
        env:
          BLACKDUCKSCA_URL: ${{ vars.BLACKDUCKSCA_URL }}
          BLACKDUCKSCA_TOKEN: ${{ secrets.BLACKDUCKSCA_TOKEN }}

      - name: Upload C/C++ Scan Results - ${{ matrix.component }}
        uses: actions/upload-artifact@v4
        with:
          name: blackduck-cpp-scan-results-${{ matrix.component }}
          path: blackduck-cpp-output/${{ matrix.component }}/
          retention-days: 7

  # Full project scan with build capture
  blackduck-cpp-full-scan:
    runs-on: ubuntu-latest
    needs: [blackducksca, blackduck-cpp-scan]
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Python for Black Duck C/C++ Scanner
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Black Duck C/C++ Scanner
        run: pip install blackduck-c-cpp==3.0.5

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Setup Build Environment
        run: |
          mkdir -p blackduck-cpp-output/full-project
          chmod +x build_all.sh
          # Create a proper build script for CMake projects
          cat > enhanced_build.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "Building utility library..."
          cd utility_library
          mkdir -p build
          cmake -B build .
          cmake --build build
          cd ..
          
          echo "Building server..."
          cd server
          mkdir -p build
          cmake -B build .
          cmake --build build
          cd ..
          
          echo "Building client..."
          cd client
          mkdir -p build
          cmake -B build .
          cmake --build build
          cd ..
          
          echo "All components built successfully!"
          EOF
          chmod +x enhanced_build.sh

      - name: Run Full Project C/C++ Scan with Build Capture
        run: |
          blackduck-c-cpp \
            -bd ${{ vars.BLACKDUCKSCA_URL }} \
            -a ${{ secrets.BLACKDUCKSCA_TOKEN }} \
            -bc "./enhanced_build.sh" \
            -d . \
            -od ./blackduck-cpp-output/full-project \
            -proj "jenkins-demo-cpp-full" \
            -vers "${{ github.sha }}" \
            -i false \
            -as "--snippet-matching --license-search --upload-source"
        env:
          BLACKDUCKSCA_URL: ${{ vars.BLACKDUCKSCA_URL }}
          BLACKDUCKSCA_TOKEN: ${{ secrets.BLACKDUCKSCA_TOKEN }}

      - name: Upload Full Project C/C++ Scan Results
        uses: actions/upload-artifact@v4
        with:
          name: blackduck-cpp-scan-results-full-project
          path: blackduck-cpp-output/full-project/
          retention-days: 7

      - name: Create Scan Summary
        run: |
          echo "# Black Duck C/C++ Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "## Components Scanned:" >> $GITHUB_STEP_SUMMARY
          echo "- Client component" >> $GITHUB_STEP_SUMMARY
          echo "- Server component" >> $GITHUB_STEP_SUMMARY
          echo "- Utility library component" >> $GITHUB_STEP_SUMMARY
          echo "- Full project build" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Details:" >> $GITHUB_STEP_SUMMARY
          echo "- Build capture enabled for accurate dependency detection" >> $GITHUB_STEP_SUMMARY
          echo "- Project version: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Scan artifacts uploaded for review" >> $GITHUB_STEP_SUMMARY